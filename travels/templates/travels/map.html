{% extends 'base.html' %}
{% load static %}



{% block style %}
<link rel="stylesheet" href="{% static 'travels/map_style.css' %}">
{% endblock %}




{% block content %}
<h1>포토스팟 찾기</h1>


<!-- 검색창 -->
<form action="" method="GET">
    <div>
        <input type="text" class="form-control" placeholder="{{ search }}" name="search">
        <button class="btn btn-outline-secondary" type="submit">검색</button>
    </div>

</form>


<div class="photospot">

    <!-- 지도를 담기 위한 영역 만들기 -->
    <div id="map" style="width:500px;height:400px;"></div>


    {% for spot in spots %}
    <!-- 포토스팟 리스트 -->
    <div class="card" style="width: 18rem;">
        <img src="{{ spot.image.url }}" class="card-img-top" alt="...">
        <div class="card-body">
            <h5 class="card-title">{{ spot.title }}</h5>
            <p class="card-text">{{ spot.short_content }}</p>

            <form action="" method="GET">
                <button type="submit" name="search" value="{{ spot.title }}">위치 확인하기</button>
            </form>
        </div>
    </div>
    {% endfor %}

</div>


<!-- 실제 지도를 그리는 Javascript API를 불러오기 & services와 clusterer, drawing 라이브러리 불러오기 -->
<script type="text/javascript"
    src="//dapi.kakao.com/v2/maps/sdk.js?appkey=7017ebc62c378fa5ebb089d1fd591804&libraries=services,clusterer,drawing"></script>


<!-- 지도를 띄우는 코드 작성 -->
<script>
    // 마커를 클릭하면 장소명을 표출할 인포윈도우 입니다
    var infowindow = new kakao.maps.InfoWindow({ zIndex: 1 });

    var mapContainer = document.getElementById('map'), // 지도를 표시할 div 
        mapOption = {
            center: new kakao.maps.LatLng(33.361365, 126.529669), // 지도의 중심좌표 -> 제주도 한라산으로 설정완료
            level: 11 // 지도의 확대 레벨
        };

    // 지도를 생성합니다    
    var map = new kakao.maps.Map(mapContainer, mapOption);
    // 마커가 표시될 위치입니다 
    var markerPosition = new kakao.maps.LatLng(33.361365, 126.529669);
    // 마커를 생성합니다
    var marker = new kakao.maps.Marker({
        position: markerPosition,
        clickable: true,
    });
    // 마커가 지도 위에 표시되도록 설정합니다
    marker.setMap(map);

    var iwContent = '<div style="padding:5px;">Hello World!</div>', // 인포윈도우에 표출될 내용으로 HTML 문자열이나 document element가 가능합니다
        iwRemoveable = true; // removeable 속성을 ture 로 설정하면 인포윈도우를 닫을 수 있는 x버튼이 표시됩니다

    // 인포윈도우를 생성합니다
    var infowindow = new kakao.maps.InfoWindow({
        content: iwContent,
        removable: iwRemoveable
    });

    infowindow.open(map, marker);

    // 지도에 지형정보를 표시하도록 지도타입을 추가합니다
    map.addOverlayMapTypeId(kakao.maps.MapTypeId.TERRAIN);
    // 지도 확대 축소를 제어할 수 있는 줌 컨트롤을 생성합니다
    var zoomControl = new kakao.maps.ZoomControl();
    map.addControl(zoomControl, kakao.maps.ControlPosition.RIGHT);


    // 장소 검색 객체를 생성합니다
    var ps = new kakao.maps.services.Places();
    // 키워드로 장소를 검색합니다
    ps.keywordSearch('{{search}}', placesSearchCB);
    // 키워드 검색 완료 시 호출되는 콜백함수 입니다
    function placesSearchCB(data, status, pagination) {
        if (status === kakao.maps.services.Status.OK) {

            // 검색된 장소 위치를 기준으로 지도 범위를 재설정하기위해
            // LatLngBounds 객체에 좌표를 추가합니다
            var bounds = new kakao.maps.LatLngBounds();

            for (var i = 0; i < data.length; i++) {
                displayMarker(data[i]);
                bounds.extend(new kakao.maps.LatLng(data[i].y, data[i].x));
            }

            // 검색된 장소 위치를 기준으로 지도 범위를 재설정합니다
            map.setBounds(bounds);
        }
    }

    // 지도에 마커를 표시하는 함수입니다
    function displayMarker(place) {
        // 마커를 생성하고 지도에 표시합니다
        var marker = new kakao.maps.Marker({
            map: map,
            position: new kakao.maps.LatLng(place.y, place.x)
        });

        // 마커에 클릭이벤트를 등록합니다
        kakao.maps.event.addListener(marker, 'click', function () {
            // 마커를 클릭하면 장소명이 인포윈도우에 표출됩니다
            // infowindow.setContent('<div style="padding:5px;font-size:12px;">' + place.place_name + '</div>');
             //infowindow.open(map, marker);
            // 커스텀 오버레이에 표시할 컨텐츠 입니다
            // 커스텀 오버레이는 아래와 같이 사용자가 자유롭게 컨텐츠를 구성하고 이벤트를 제어할 수 있기 때문에
            // 별도의 이벤트 메소드를 제공하지 않습니다 
            var content = '<div class="wrap">' +
                '    <div class="info">' +
                '        <div class="title">' +
                place.place_name +
                '            <div class="close" onclick="closeOverlay()" title="닫기"></div>' +
                '        </div>' +
                '        <div class="body">' +
                // '            <div class="img">' +
                // '                <img src="place.place_url" width="73" height="70">' +
                // '           </div>' + 
                '            <div class="desc">' +
                '                <div class="ellipsis">' + place.address_name + '</div>' +
                '                <div class="ellipsis">' + place.phone + '</div>' +
                '                <div><a href="https://www.kakaocorp.com/main" target="_blank" class="link">자세히 보기</a></div>' +
                '            </div>' +
                '        </div>' +
                '    </div>' +
                '</div>';

            // 마커 위에 커스텀오버레이를 표시합니다
            // 마커를 중심으로 커스텀 오버레이를 표시하기위해 CSS를 이용해 위치를 설정했습니다
            var overlay = new kakao.maps.CustomOverlay({
                content: content,
                map: map,
                position: marker.getPosition()
            });



            // 커스텀 오버레이를 닫기 위해 호출되는 함수입니다 
            function closeOverlay() {
                clseBtn.overlay.setMap(null);
            }

            overlay.setMap(map);

        });

    }
</script>


{% endblock %}