{% extends 'base.html' %}
{% load static %}

{% block style %}
<link rel="stylesheet" href="{% static 'travels/map_style.css' %}">
{% endblock %}

{% block content %}
<h1>포토스팟 찾기</h1>

<!-- 검색창 -->

<h2>MAP</h2>

{%if user.is_authenticated %}
<div>
  <form action="" method="post">
    {%csrf_token%}
    <label>좋아요<input id="selected" type="checkbox" name="selected" value="1"></label>
    <label>전체<input id="selected" type="checkbox" name="selected" value="2">
      <button type="submit">확인</button>
  </form>
</div>
{%endif%}

<div class="container">

  <div id="map" style="width:1000px;height:800px;margin:20px"></div>

  <div id="card">
    <div id="card_image">
      <img id="image_test" src="/media/travels/default.png" alt="default_image">
    </div>
    <div id="card_title">
      <!-- <h3>이호태우 등대</h5> -->
    </div>
    <div id="card_content">
      <!-- <p>푸른 바다와 귀여운 조랑말 등대가 있는 포토스팟</p> -->
    </div>
    <button id="btn"><a id="btn_a" href="/travels/spots/1/">자세히 보기</a> </button>
  </div>
</div>

<div id="lat" style="display:none">
  {% for re in spots %}
  {{ re.latitude}},
  {% endfor %}
</div>

<div id="lng" style="display:none">
  {% for re in spots %}
  {{ re.longitude}},
  {% endfor %}
</div>

<div id="name" style="display:none">
  {% for re in spots %}
  {{ re.title}},
  {% endfor %}
</div>

<div id="hashtag" style="display:none">
  {% for re in spots %}
  {{ re.hashtag}},
  {% endfor %}
</div>

<div id="image" style="display:none">
  {% for re in spots %}
  {{ re.image.url}},
  {% endfor %}
</div>

<div id="id" style="display: none;">
  {% for re in spots %}
  {{ re.id}},
  {% endfor %}
</div>

<script type="text/javascript"
  src="//dapi.kakao.com/v2/maps/sdk.js?appkey=7017ebc62c378fa5ebb089d1fd591804&libraries=services,clusterer,drawing"></script>
<script>
  var mapContainer = document.getElementById('map'), // 지도를 표시할 div  
    mapOption = {
      center: new kakao.maps.LatLng(33.5013521, 126.453379), // 지도의 중심좌표
      level: 10// 지도의 확대 레벨
    };

  var map = new kakao.maps.Map(mapContainer, mapOption); // 지도를 생성합니다

  // 마커를 표시할 위치와 title 객체 배열입니다 

  var list_lat = document.getElementById("lat").innerText.split(',');
  var list_lng = document.getElementById("lng").innerText.split(',');
  var list_name = document.getElementById("name").innerText.split(',');
  var list_image = document.getElementById("image").innerText.split(',');
  var list_hashtag = document.getElementById("hashtag").innerText.split(',');
  var list_id_number = document.getElementById("id").innerText.split(',');

  var positions = new Array();
  var id_array = [];
  var location_name = [];

  for (var i = 0; i < list_lat.length; i++) {
    var latitude = list_lat[i];
    var longitude = list_lng[i];
    var number = list_id_number[i];
    var name = list_name[i];

    positions.push(new kakao.maps.LatLng(latitude, longitude));
    id_array.push(number);
    location_name.push(name);
  }

  // 마커 이미지의 이미지 주소입니다
  var imageSrc = "https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/markerStar.png";

  for (var i = 0; i < positions.length; i++) {

    // 마커 이미지의 이미지 크기 입니다
    var imageSize = new kakao.maps.Size(24, 35);

    // 마커 이미지를 생성합니다    
    var markerImage = new kakao.maps.MarkerImage(imageSrc, imageSize);

    // 마커를 생성합니다
    var marker = new kakao.maps.Marker({
      map: map, // 마커를 표시할 지도
      position: positions[i], // 마커를 표시할 위치
      image: markerImage, // 마커 이미지 
    });

    // var content1 = '<div class="wrap">' +
    //   '     <div class="info">' +
    //   '        <div class="title">' +
    //   '            이호테우 등대' +
    //   '            <div class="close" onclick="closeOverlay()" title="닫기"></div>' +
    //   '        </div>' +
    //   '        <div class="body">' +
    //   '            <div class="img">' +
    //   '                <img src="/media/travels/1이호테우등대1.jpg" width="73" height="70">' +
    //   '           </div>' +
    //   '            <div class="desc">' +
    //   '                <div class="ellipsis">제주특별자치도</div>' +
    //   '                <div class="jibun ellipsis">(우) 63309 (지번) 영평동 2181</div>' +
    //   '                <div><a href="http://localhost:8000/travels/spots/1/" target="_blank" class="link">자세히 보기</a></div>' +
    //   '            </div>' +
    //   '        </div>' +
    //   '    </div>' +
    //   '</div>';

    var iwContent = "<div style='height:60px; width:300px;'>" + list_id_number[i] + list_name[i] + "</br>" + list_hashtag[i] + "</div>" + "<img style='height: 300px; width:300px;' src=" + list_image[i] + ">";
    
    const test = list_name[i];
    const test_image = list_image[i];
    // 상백 추가
    const test_id = list_id_number[i];
    const id = test_id.replace(/\s*/g, "");

    var infoWindow = new kakao.maps.InfoWindow({
      content: iwContent
    });

    (function (marker, infoWindow) {
      kakao.maps.event.addListener(marker, 'mouseover', function () {
        infoWindow.open(map, marker);
      })
      kakao.maps.event.addListener(marker, 'mouseout', function () {
        infoWindow.close();
      })

      kakao.maps.event.addListener(marker, 'click', function () {
        //console.log(marker);
        document.getElementById('card_content').innerHTML = test;
        document.getElementById('image_test').src = test_image;
        // 상백 추가
        document.getElementById('btn_a').href = '/travels/spots/' + id + '/';
      })
    })(marker, infoWindow);

    marker.setMap(map);

    // var $card_image = document.getElementById("card_image");
    // var $card_title = document.getElementById("card_title");
    // var $card_content = document.getElementById("card_content");

    // var clicked_marker_positions = marker.getPosition();
  }

</script>
{% endblock %}